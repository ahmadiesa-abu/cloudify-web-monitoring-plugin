tosca_definitions_version: cloudify_dsl_1_3

description: >
  This blueprint create a managed cluster.
imports:
  - https://cloudify.co/spec/cloudify/5.1.0/types.yaml
  - plugin:cloudify-azure-plugin?version= >=2.1.10


inputs:
  # Azure account information
  subscription_id:
    type: string
    required: false
    default: { get_secret: azure_subscription_id }

  tenant_id:
    type: string
    required: false
    default: { get_secret: azure_tenant_id }

  client_id:
    type: string
    required: false
    default: { get_secret: azure_client_id }

  client_secret:
    type: string
    required: false
    default: { get_secret: azure_client_secret }

  azure_location:
    type: string
    default: 'eastus'

  resource_group_name:
    type: string
    default: 'testmonitoraks'

  managed_cluster_name:
    type: string
    default: 'testmonitoraks'

  agent_pool_name:
    type: string
    default: 'agentpool'

node_types:
  node_agent_pool_scaler:
    derived_from: cloudify.nodes.Root
    properties:
      azure_config:
        default: {}
      resource_group_name:
        type: string
      cluster_name:
        type: string
      agent_pool_name:
        type: string
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: scripts/get_agent_pool.py
          executor: central_deployment_agent
          inputs:
            azure_config:
              default: { get_property: [ SELF, azure_config ] }
            resource_group_name:
              default: { get_property: [ SELF, resource_group_name ] }
            cluster_name:
              default: { get_property: [ SELF, cluster_name ] }
            agent_pool_name:
              default: { get_property: [ SELF, agent_pool_name ] }
      scale_nodes:
        scale_up:
          implementation: scripts/scale_nodes.py
          executor: central_deployment_agent
          inputs:
            azure_config:
              default: { get_property: [ SELF, azure_config ] }
            resource_group_name:
              default: { get_property: [ SELF, resource_group_name ] }
            cluster_name:
              default: { get_property: [ SELF, cluster_name ] }
            agent_pool_name:
              default: { get_property: [ SELF, agent_pool_name ] }
            delta:
              default: 1
        scale_down:
          implementation: scripts/scale_nodes.py
          executor: central_deployment_agent
          inputs:
            azure_config:
              default: { get_property: [ SELF, azure_config ] }
            resource_group_name:
              default: { get_property: [ SELF, resource_group_name ] }
            cluster_name:
              default: { get_property: [ SELF, cluster_name ] }
            agent_pool_name:
              default: { get_property: [ SELF, agent_pool_name ] }
            delta:
              default: -1

dsl_definitions:
  azure_config: &azure_config
    subscription_id: { get_input: subscription_id }
    tenant_id: { get_input: tenant_id }
    client_id: { get_input: client_id }
    client_secret: { get_input: client_secret }

node_templates:
    node_agent_pool:
      type: node_agent_pool_scaler
      properties:
        azure_config: *azure_config
        resource_group_name: { get_input: resource_group_name }
        cluster_name: { get_input: managed_cluster_name }
        agent_pool_name: { get_input: agent_pool_name }
